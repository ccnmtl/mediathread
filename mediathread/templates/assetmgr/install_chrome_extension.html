{% load staticfiles %}

<div id="chrome-install-container">
    {% if CAS_BASE == 'https://cas.columbia.edu' %}
        <button class="btn btn-primary" id="chrome-install-button">
            Visit Chrome Web Store
        </button>
    {% else %}
        <a class="btn btn-primary"
           target="_blank"
           href="https://chrome.google.com/webstore/detail/mediathread/gambcgmmppeklfmbahomokogelnaffbi">
            Visit Chrome Web Store
        </a>
    {% endif %}
    <hr>
    <p>
        If you're connecting to a non-Columbia Mediathread instance,
        you'll need to update the extension's URL.
    </p>
    <button class="btn btn-outline-secondary update-chrome-extension-hosturl">
        Update Mediathread URL
    </button>
    <div class="update-chrome-extension-feedback"></div>
    <div class="clearfix"></div>
</div>

<script>
(function() {
    var markAsInstalled = function($button) {
        $button.text('Installed.');
        $button.removeClass('btn-primary');
        $button.addClass('btn-default disabled');
    };

    jQuery(document).ready(function() {
        var $button = jQuery('#chrome-install-button');
        $button.on('click', function(e) {
            if (jQuery(this).hasClass('disabled')) {
                return;
            }
            chrome.webstore.install(
                'https://chrome.google.com/webstore/detail/gambcgmmppeklfmbahomokogelnaffbi',
                function() {
                    // Success handler
                    markAsInstalled($button);

                    var extensionId = 'gambcgmmppeklfmbahomokogelnaffbi';

                    chrome.runtime.sendMessage(
                        extensionId, {
                            command: 'updatesettings'
                        }, function(response) {
                            var $el = jQuery('.update-chrome-extension-feedback');
                            var defaultResponse = 'Settings Updated.';
                            var msg = response ? response : defaultResponse;

                            $el.hide();
                            $el.text(msg);
                            $el.addClass('alert alert-info')
                            $el.fadeIn();
                        });
                }
            );
        });
    });
})();
</script>
